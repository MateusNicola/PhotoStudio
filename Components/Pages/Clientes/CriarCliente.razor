@page "/clientes/criarCliente"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using PhotoStudio.app.Models
@using PhotoStudio.app.Data
@using PhotoStudio.app.Services
@using PhotoStudio.app.Services.Clientes
@using PhotoStudio.app.Components.Shared
@inject NavigationManager Navigation
@inject ToastService ToastService
@inject ClienteService ClienteService
@inject IHttpClientFactory ClientFactory
@attribute [Authorize]

<PageTitle>Cliente - Estúdio de Fotografia</PageTitle>

<JanelaConfirmacao @ref="janelaConfirmacao" Title="Excluir Cliente" Message="Tem certeza que deseja excluir este cliente?" />

<div class="page-container">
    <div class="page-header">
        <div class="header-content">
            <button class="btn-back" @onclick="Voltar" title="Voltar">
                <span>←</span>
            </button>
            <div class="header-text">
                <h1>@(novoCliente.Id > 0 ? "Editar Cliente" : "Novo Cliente")</h1>
            </div>

            <div class="actions-right">
                <button type="button" class="btn btn-primary" @onclick="SalvarCliente" disabled="@salvando">
                    @if (salvando)
                    {
                        <span class="spinner"></span>
                        <span>Salvando...</span>
                    }
                    else
                    {
                        <span>💾 Salvar</span>
                    }
                </button>

                @if (novoCliente.Id > 0)
                {
                    <button type="button" class="btn btn-delete" @onclick="ExcluirCliente">
                        <span>🗑️ Excluir</span>
                    </button>
                }
            </div>
        </div>
    </div>

    <div class="form-container">
        @* --- NAVEGAÇÃO DE ABAS --- *@
        <div class="tabs-container">
            <button type="button" class="tab-btn @(activeTab == 1 ? "active" : "")" @onclick="() => activeTab = 1">
                👤 Dados Gerais
            </button>
            <button type="button" class="tab-btn @(activeTab == 2 ? "active" : "")" @onclick="() => activeTab = 2">
                📍 Endereço
            </button>
        </div>

        <EditForm Model="@novoCliente" OnValidSubmit="SalvarCliente">
            <DataAnnotationsValidator />

            @* --- ABA 1: DADOS GERAIS --- *@
            <div class="tab-content @(activeTab == 1 ? "show" : "hide")">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="nome">Nome Completo *</label>
                        <InputText id="nome" class="form-control" @bind-Value="novoCliente.Nome" placeholder="Ex: João da Silva" />
                        <ValidationMessage For="@(() => novoCliente.Nome)" />
                    </div>

                    <div class="form-group">
                        <label for="telefone">Telefone *</label>
                        <InputText id="telefone" class="form-control" @bind-Value="novoCliente.Telefone"
                                   @oninput="AplicarMascaraTelefone" maxlength="15" placeholder="(00) 00000-0000" />
                        <ValidationMessage For="@(() => novoCliente.Telefone)" />
                    </div>

                    <div class="form-group">
                        <label for="email">E-mail *</label>
                        <InputText id="email" type="email" class="form-control" @bind-Value="novoCliente.Email" placeholder="exemplo@email.com" />
                        <ValidationMessage For="@(() => novoCliente.Email)" />
                    </div>
                </div>
            </div>

            @* --- ABA 2: ENDEREÇO --- *@
            <div class="tab-content @(activeTab == 2 ? "show" : "hide")">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cep">CEP</label>
                        <div class="input-with-loader">
                            <InputText id="cep" class="form-control" @bind-Value="novoCliente.CEP" 
                                       @oninput="OnCEPInput" placeholder="00000-000" maxlength="9" />
                            @if (buscandoCep) { <span class="spinner-inline"></span> }
                        </div>
                        <ValidationMessage For="@(() => novoCliente.CEP)" />
                    </div>

                    <div class="form-group">
                        <label for="pais">País</label>
                        <InputText id="pais" class="form-control" @bind-Value="novoCliente.Pais" placeholder="Brasil" />
                    </div>

                    <div class="form-group full-width">
                        <label for="logradouro">Logradouro (Rua/Av)</label>
                        <InputText id="logradouro" class="form-control" @bind-Value="novoCliente.Logradouro" />
                    </div>

                    <div class="form-group">
                        <label for="numero">Número</label>
                        <InputText id="numero" class="form-control" @bind-Value="novoCliente.Numero" />
                    </div>

                    <div class="form-group">
                        <label for="complemento">Complemento</label>
                        <InputText id="complemento" class="form-control" @bind-Value="novoCliente.Complemento" />
                    </div>

                    <div class="form-group">
                        <label for="bairro">Bairro</label>
                        <InputText id="bairro" class="form-control" @bind-Value="novoCliente.Bairro" />
                    </div>

                    <div class="form-group">
                        <label for="cidade">Cidade</label>
                        <InputText id="cidade" class="form-control" @bind-Value="novoCliente.Cidade" />
                    </div>

                    <div class="form-group">
                        <label for="estado">Estado (UF)</label>
                        <InputSelect id="estado" class="form-control" @bind-Value="novoCliente.Estado">
                            <option value="">Selecione...</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amapá</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Ceará</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Espírito Santo</option>
                            <option value="GO">Goiás</option>
                            <option value="MA">Maranhão</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Pará</option>
                            <option value="PB">Paraíba</option>
                            <option value="PR">Paraná</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piauí</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rondônia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">São Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </InputSelect>
                    </div>
                </div>
            </div>
        </EditForm>
    </div>
</div>

<style>
    .page-container { max-width: 900px; margin: 0 auto; padding: 20px; font-family: sans-serif; }
    .page-header { margin-bottom: 32px; }
    .header-content { display: flex; align-items: center; gap: 16px; }
    .btn-back { background: #f7fafc; border: 2px solid #e2e8f0; border-radius: 10px; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .header-text { flex: 1; }
    .header-text h1 { font-size: 2rem; color: #2d3748; margin: 0; }
    .actions-right { display: flex; gap: 12px; }

    .form-container { background: white; border-radius: 12px; padding: 32px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

    /* Tabs UI */
    .tabs-container { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid #edf2f7; }
    .tab-btn { padding: 12px 24px; border: none; background: none; font-weight: 600; color: #718096; cursor: pointer; position: relative; }
    .tab-btn.active { color: #667eea; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: #667eea; }
    .tab-content.hide { display: none; }
    .tab-content.show { display: block; animation: fadeIn 0.3s; }

    .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .full-width { grid-column: 1 / -1; }
    .form-group { display: flex; flex-direction: column; }
    label { font-weight: 600; margin-bottom: 8px; color: #4a5568; }
    .form-control { padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }
    
    .input-with-loader { position: relative; display: flex; align-items: center; }
    .spinner-inline { position: absolute; right: 12px; width: 18px; height: 18px; border: 2px solid #e2e8f0; border-top-color: #667eea; border-radius: 50%; animation: spin 0.6s linear infinite; }

    .btn { padding: 10px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-delete { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }
    .btn:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }

    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @@keyframes spin { to { transform: rotate(360deg); } }

    @@media (max-width: 768px) {
        .form-grid { grid-template-columns: 1fr; }
        .header-content { flex-direction: column; align-items: flex-start; }
        .actions-right { width: 100%; margin-top: 10px; }
    }
</style>

@code {
    private int activeTab = 1;
    private ClienteModel novoCliente = new() { Pais = "Brasil" };
    private bool buscandoCep = false;
    private bool salvando = false;
    private JanelaConfirmacao? janelaConfirmacao;

    // Mascara e Busca Automática de CEP
    private async Task OnCEPInput(ChangeEventArgs e)
    {
        var val = e.Value?.ToString() ?? "";
        var n = new string(val.Where(char.IsDigit).ToArray());

        if (n.Length > 8) n = n.Substring(0, 8);

        // Aplica mascara XXXXX-XXX
        if (n.Length > 5)
            novoCliente.CEP = $"{n.Substring(0, 5)}-{n.Substring(5)}";
        else
            novoCliente.CEP = n;

        // Se atingiu 8 dígitos, busca automaticamente
        if (n.Length == 8)
        {
            await BuscarCEP(n);
        }
    }

    private async Task BuscarCEP(string cepLimpo)
    {
        buscandoCep = true;
        try
        {
            var client = ClientFactory.CreateClient();
            var response = await client.GetFromJsonAsync<ViaCepResponse>($"https://viacep.com.br/ws/{cepLimpo}/json/");
            if (response != null && !response.Erro)
            {
                novoCliente.Logradouro = response.Logradouro;
                novoCliente.Bairro = response.Bairro;
                novoCliente.Cidade = response.Localidade;
                novoCliente.Estado = response.Uf;
                novoCliente.Pais = "Brasil";
                ToastService.Success("Endereço preenchido!");
            }
        }
        catch { ToastService.Error("Erro ao consultar CEP."); }
        finally { buscandoCep = false; }
    }

    private async Task SalvarCliente()
    {
        if (string.IsNullOrWhiteSpace(novoCliente.Nome)) 
        {
            activeTab = 1;
            return;
        }

        salvando = true;
        try
        {
            await ClienteService.CriarAsync(novoCliente);
            ToastService.Success("Cliente salvo!");
            Voltar();
        }
        catch (Exception ex) { ToastService.Error(ex.Message); }
        finally { salvando = false; }
    }

    private async Task ExcluirCliente()
    {
        if (janelaConfirmacao != null && await janelaConfirmacao.Show())
        {
            await ClienteService.ExcluirAsync(novoCliente.Id);
            ToastService.Success("Cliente excluído.");
            Voltar();
        }
    }

    private void Voltar() => Navigation.NavigateTo("/clientes");

    private void AplicarMascaraTelefone(ChangeEventArgs e)
    {
        var val = e.Value?.ToString() ?? "";
        var n = new string(val.Where(char.IsDigit).ToArray());
        if (n.Length > 11) n = n.Substring(0, 11);

        if (n.Length <= 2)
            novoCliente.Telefone = n.Length > 0 ? $"({n}" : "";
        else if (n.Length <= 7)
            novoCliente.Telefone = $"({n.Substring(0, 2)}) {n.Substring(2)}";
        else
            novoCliente.Telefone = $"({n.Substring(0, 2)}) {n.Substring(2, 5)}-{n.Substring(7)}";
    }

    public class ViaCepResponse
    {
        public string Logradouro { get; set; } = "";
        public string Bairro { get; set; } = "";
        public string Localidade { get; set; } = "";
        public string Uf { get; set; } = "";
        public bool Erro { get; set; }
    }
}